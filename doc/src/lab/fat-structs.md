# FAT構造体

## MBR (Master Boot Record)

| オフセット | サイズ（バイト） | 説明 |
|-----------:|-----------------:|:-----|
| 0 | 430 | MBR **Bootstrap** （バイナリ実行可能コード） |
| 436 | 10 | オプションの「一意な」ディスクID |
| 446 | 64 | MBR **パーティションテーブル**、4エントリ |
| 446 | 16 | 第1パーティションテーブルエントリ |
| 462 | 16 | 第2パーティションテーブルエントリ |
| 478 | 16 | 第3パーティションテーブルエントリ |
| 494 | 16 | 第4パーティションテーブルエントリ |
| 510 | 2 | (`0x55`, `0xAA`) 「有効なブートセクタ」シグネチャバイト |

## パーティションエントリ

| オフセット | サイズ | 説明 |
|-----------:|-----------------:|:-----|
| 0 | 1 バイト | ブートインジケータビットフラグ: 0 = no, 0x80 = ブート可能 |
| 1 | 1 バイト | ヘッドの開始位置 |
| 2 | 6 ビット | セクタの開始位置（ビット7-8はシリンダ開始フィールドの上位2ビット） |
| 3 | 10 ビット | シリンダの開始位置 |
| 4 | 1 バイト | パーティション種別（FAT32では`0xB`か`0xC`） |
| 5 | 1 バイト | ヘッドの終了位置 |
| 6 | 6 ビット | セクタの終了位置（ビット7-8はシリンダ終了フィールドの上位2ビット） |
| 7 | 10 ビット | シリンダの終了位置 |
| 8 | 4 バイト | 相対セクタ（パーティションの開始位置からのバイト単位のオフセット） |
| 12 | 4 バイト | パーティションの総セクタ数 |

## BPB (BIOS Parameter Block)

すべての数値はリトルエンディアン形式

| オフセット<br/>（バイト） | サイズ<br/>（バイト） | 説明 |
|-----------:|-----------------:|:-----|
| 0 | 3 | 最初の3バイトの`EB XX 90` は `JMP SHORT XX NOP`に翻訳される |
| 3 | 8 | OEM識別子 |
| 11 | 2 | セクタあたりのバイト数 |
| 13 | 1 | クラスタあたりのセクタ数 |
| 14 | 2 | 予約セクタ数 （ブートレコードセクタはこの値に含まれる） |
| 16 | 1 | ストレージメディアのFAT数、通常は 2 |
| 17 | 2 | ディレクトリエントリの最大数（FAT32の場合は 0 でデータ領域に格納される |
| 19 | 2 | 総論理セクタ数（0の場合はオフセット32の4バイト値を使用する） |
| 21 | 1 | メディアディスクリプタ種別を示す（FAT ID） |
| 22 | 2 | FATあたりのセクタ数（FAT32の場合は 0 でオフセット36の32ビット値を使用する） |
| 24 | 2 | トラックあたりのセクタ数 |
| 26 | 2 | ストレージメディアのヘッド数、または面数 |
| 28 | 4 | 隠しセクタ数（パーティション先頭のLBA） |
| 32 | 4 | 総論理セクタ数（65535を超える場合、それ以外はオフセット19を使用） |

## EBPB (Extended BPB)

| オフセット<br/>（バイト） | サイズ<br/>（バイト） | 説明 |
|-----------:|-----------------:|:-----|
| 36 | 4 | FATあたりのセクタ数（セクタ単位のFATのサイズ） |
| 40 | 2 | フラグ |
| 42 | 2 | FATバージョン番号（42: メジャーバージョン、43: マイナーバージョン） |
| 44 | 4 | ルートディレクトリのクラスタ番号 |
| 48 | 2 | FSInfo構造体のセクタ番号 |
| 50 | 2 | バックアップブートセクタのセクタ番号 |
| 52 | 12 | 予約。 |
| 64 | 1 | ドライブ番号。ハードディスクは`0x80` |
| 65 | 1 | Windows NTのフラグ。その他は予約 |
| 66 | 1 | シグネチャ（`0x28`か`0x29`） |
| 67 | 4 | VolumeID "シリアル"番号 |
| 71 | 11 | ボリュームラベル文字列。空白詰め |
| 82 | 8 | システム識別子文字列。常に"FAT32   " |
| 90 | 420 | ブートコード |
| 510 | 2 | `0xAA55` ブータブルパーティションシグネチャ |

## FATエントリ（28ビット）

**エントリ 0**: `0xFFFFFFFN`, ID<br/>
**エントリ 1**: クラスタチェーン終端マーカー（通常`0x0FFFFFFF`、FAT32では`0x0FFFFFF8`

| FAT32エントリ値 | 説明 |
|:----------------|:-----|
| 0x?0000000 | 空きクラスタ |
| 0x?0000001 | 内部使用用に予約 |
| 0x?0000002 -0x?FFFFFEF | データクラスタに使用。<br/>値はチェーン内の次のクラスタを指し示す |
| 0x?FFFFFF0 -0x?FFFFFF5 | ある種のコンテキストでは予約、<br/>何らかの非標準システムではデータクラスとして使用 |
| 0x?FFFFFF6 | 予約; 使用しないこと |
| 0x?FFFFFF7 | クラスタ内の不良セクタまたは予約セクタ |
| 0x?FFFFFF8 -0x?FFFFFFF | EOC (endo fo chain) マーカー |

## 通常のディレクトリエントリ

- エントリの先頭バイトは（通常エントリ、LFNをとわず）IDとしても知られている

  **`ID=0x00`**: ディレクトリの終りを示す<br/>
  **`ID=0xE5`**: 未使用/削除済エントリをマークする<br/>
  その他のすべてのIDはファイル名の一部、または、LFNシーケンス番号を構成する

- オフセット11のバイトはエントリが通常エントリであるか、LFNエントリであるかを
  決定する

  **`Value=0x0F`**: エントリはLFNエントリ
  **その他の値**: エントリは通常エントリ

| オフセット | サイズ（バイト） | 説明 |
|-----------:|-----------------:|:-----|
| 0 | 8 | ファイル名：8 Ascii文字<br/>`0x00`または`0x20`詰め可能<br/>ファイル名が`0x00`で始まる場合は前のエントリが最後のエントリ<br/>`0xE5`で始まる場合は削除/未使用エントリ |
| 8 | 3 | ファイル拡張子. 3 Ascii文字<br/>`0x00`または`0x20`詰め可能 |
| 11 | 1 | ファイル属性。可能な属性は次の通り<br/>READ_ONLY=0x01, HIDDEN=0x02<br/>SYSTEM=0x04, VOLUME_ID=0x08<br/>DIRECTORY=0x10, ARCHIVE=0x20<br/>LFN=READ_ONLY\|HIDDEN\|SYSTEM\|VOLUME_ID<br/>（LFN(=`0x0F`)はこのエントリがLFNエントリであることを示す） |
| 12 | 1 | WindowsNT用に予約 |
| 13 | 1 | 1/10秒単位の作成時間 |
| 14 | 2 | ファイル作成時: Bits 15-11: 時, 10-5: 分, 4-0: 秒/2 |
| 16 | 2 | ファイル作成日: Bit 15-9: 年 (0=1980), 8-5: 月, 4-0: 日 |
| 18 | 2 | 最終アクセス日 |
| 20 | 2 | このエントリの最初のクラスタ番号の上位16ビット |
| 22 | 2 | 最終更新時 |
| 24 | 2 | 最終更新日 |
| 26 | 2 | このエントリの最初のクラスタ番号の下位16ビット |
| 28 | 4 | バイト単位のファイルサイズ |

## LFN (Lnng File Name)エントリ

| オフセット<br/>（バイト） | サイズ<br/>（バイト） | 説明 |
|-----------:|-----------------:|:-----|
| 0 | 1 | シーケンス番号<br/>ビット6がセット: 最後の論理LFNエントリ<br/>ビット5がクリア: 最初の物理LFNエントリ<br/>ビット4-0: 0x01～0x14(0x1F)：エントリの位置<br/>シーケンス番号が0x00の場合、前のエントリが最後のエントリ<br/>シーケンス番号が0xE5の場合、このエントリは削除/未使用エントリ |
| 1 | 10 | 名前文字列（UCS-2で5文字）`0x00`, `0xFF`詰め可能 |
| 11 | 1 | 属性（常に`0x0F`）。ディレクトリエントリがLFNエントリであることを示す |
| 12 | 1 | 種別（`0x00`: VFAT LFN, その他は予約） |
| 13 | 1 | DOSファイル名のチェックサム |
| 14 | 12 | 2番目の名前文字列（UCS-2で6文字） |
| 26 | 2 | LFNでは常に`0x0000` |
| 28 | 4 | 3番目の名前文字列（UCS-2で2文字） |
